(() => {
  // Get references to DOM elements
  const nav = document.querySelector('nav');
  const main = document.querySelector('main');
  const darkToggle = document.getElementById('darkModeToggle');
  const chatbotForm = document.getElementById('chatbot-form');
  const chatbotInput = document.getElementById('chatbot-input');
  const chatbotSendBtn = document.getElementById('chatbot-send-btn');
  const chatbotMessages = document.getElementById('chatbot-messages');

  // Module data copied from earlier HTML inline data
  const modules = [
    {
      id: 'seo',
      title: 'Search Engine Optimization (SEO)',
      description: {
        en: `SEO is the practice of optimizing your website to rank higher in search engine results, increasing organic traffic.`,
        ta: `SEO à®Žà®©à¯à®ªà®¤à¯ à®‰à®™à¯à®•à®³à¯ à®µà®²à¯ˆà®¤à¯à®¤à®³à®¤à¯à®¤à¯ˆ à®¤à¯‡à®Ÿà¯à®ªà¯Šà®±à®¿ à®®à¯à®Ÿà®¿à®µà¯à®•à®³à®¿à®²à¯ à®®à¯‡à®²à¯à®¨à®¿à®²à¯ˆ à®ªà¯†à®±à®šà¯ à®šà¯†à®¯à¯à®¯à¯à®®à¯ à®®à¯à®±à¯ˆà®¯à®¾à®•à¯à®®à¯, à®‡à®¤à¯ à®‡à®¯à®²à¯à®ªà¯à®¨à®¿à®²à¯ˆà®ªà¯ à®ªà¯‹à®•à¯à®•à¯à®µà®°à®¤à¯à®¤à¯ˆ à®…à®¤à®¿à®•à®°à®¿à®•à¯à®•à®¿à®±à®¤à¯.`,
      },
      source: 'https://moz.com/beginners-guide-to-seo',
      quiz: {
        question: 'Which of these is NOT a common SEO practice?',
        options: [
          'Keyword research',
          'Backlink building',
          'Buying fake followers',
          'On-page optimization'
        ],
        answerIndex: 2
      }
    },
    {
      id: 'social-media',
      title: 'Social Media Marketing',
      description: {
        en: `Marketing using platforms like Facebook, Instagram, Twitter to engage and grow your audience.`,
        ta: `Facebook, Instagram, Twitter à®ªà¯‹à®©à¯à®± à®¤à®³à®™à¯à®•à®³à¯ˆà®ªà¯ à®ªà®¯à®©à¯à®ªà®Ÿà¯à®¤à¯à®¤à®¿ à®®à®•à¯à®•à®³à¯ à®¤à¯Šà®Ÿà®°à¯à®ªà¯ˆ à®µà®³à®°à¯à®ªà¯à®ªà®¤à¯.`,
      },
      source: 'https://sproutsocial.com/insights/social-media-marketing-strategy/',
      quiz: {
        question: 'Which platform is best known for professional networking?',
        options: [
          'Facebook',
          'Instagram',
          'LinkedIn',
          'Snapchat'
        ],
        answerIndex: 2
      }
    },
    {
      id: 'google-ads',
      title: 'Google Ads',
      description: {
        en: `Paid advertising on Google to reach customers instantly with targeted ads.`,
        ta: `à®•à¯‚à®•à¯à®³à®¿à®²à¯ à®ªà®£à®®à¯ à®šà¯†à®²à¯à®¤à¯à®¤à®¿ à®µà®¿à®³à®®à¯à®ªà®°à®™à¯à®•à®³à¯ˆ à®¨à®Ÿà®¾à®¤à¯à®¤à®¿ à®•à¯à®±à®¿à®•à¯à®•à¯‹à®³à¯ à®µà®¾à®Ÿà®¿à®•à¯à®•à¯ˆà®¯à®¾à®³à®°à¯à®•à®³à¯ˆ à®…à®Ÿà¯ˆà®¯à®²à®¾à®®à¯.`,
      },
      source: 'https://ads.google.com/home/',
      quiz: {
        question: 'What does CPC stand for in Google Ads?',
        options: [
          'Cost Per Click',
          'Cost Per Customer',
          'Click Per Cost',
          'Customer Paid Cost'
        ],
        answerIndex: 0
      }
    },
    {
      id: 'email-marketing',
      title: 'Email Marketing',
      description: {
        en: `Sending targeted emails to nurture leads and convert customers.`,
        ta: `à®‡à®£à¯ˆà®ªà¯à®ªà¯à®•à¯ à®•à®Ÿà®¿à®¤à®™à¯à®•à®³à¯ à®…à®©à¯à®ªà¯à®ªà®¿ à®µà®¾à®Ÿà®¿à®•à¯à®•à¯ˆà®¯à®¾à®³à®°à¯à®•à®³à¯ˆ à®®à®¾à®±à¯à®±à¯à®¤à®²à¯.`,
      },
      source: 'https://mailchimp.com/email-marketing/',
      quiz: {
        question: 'Which is a good practice in email marketing?',
        options: [
          'Sending spam emails',
          'Personalizing emails',
          'Ignoring unsubscribe requests',
          'Buying email lists'
        ],
        answerIndex: 1
      }
    },
    {
      id: 'affiliate-marketing',
      title: 'Affiliate Marketing',
      description: {
        en: `Promoting other companiesâ€™ products to earn commissions.`,
        ta: `à®ªà®¿à®± à®¨à®¿à®±à¯à®µà®©à®™à¯à®•à®³à®¿à®©à¯ à®¤à®¯à®¾à®°à®¿à®ªà¯à®ªà¯à®•à®³à¯ˆ à®µà®¿à®³à®®à¯à®ªà®°à®®à¯ à®šà¯†à®¯à¯à®¤à¯ à®•à®®à®¿à®·à®©à¯ à®ªà¯†à®±à¯à®¤à®²à¯.`,
      },
      source: 'https://www.bigcommerce.com/articles/affiliate-marketing/',
      quiz: {
        question: 'Affiliate marketers earn money based on:',
        options: [
          'Product views',
          'Clicks on ads',
          'Sales or leads generated',
          'Social media followers'
        ],
        answerIndex: 2
      }
    },
    {
      id: 'analytics',
      title: 'Web Analytics',
      description: {
        en: `Tracking and analyzing website data to improve marketing efforts.`,
        ta: `à®‡à®£à¯ˆà®¯à®¤à¯à®¤à®³ à®¤à®°à®µà¯ˆ à®•à®£à¯à®•à®¾à®£à®¿à®¤à¯à®¤à¯ à®šà®¨à¯à®¤à¯ˆà®ªà¯à®ªà®Ÿà¯à®¤à¯à®¤à®²à¯ à®®à¯‡à®®à¯à®ªà®Ÿà¯à®¤à¯à®¤à®²à¯.`,
      },
      source: 'https://analytics.google.com/',
      quiz: {
        question: 'Which metric measures website visitor count?',
        options: [
          'Bounce Rate',
          'Sessions',
          'CTR',
          'Impressions'
        ],
        answerIndex: 1
      }
    },
    {
      id: 'content-marketing',
      title: 'Content Marketing',
      description: {
        en: `Creating valuable content to attract and engage your audience.`,
        ta: `à®®à®¤à®¿à®ªà¯à®ªà¯à®®à®¿à®•à¯à®• à®‰à®³à¯à®³à®Ÿà®•à¯à®•à®®à¯ à®‰à®°à¯à®µà®¾à®•à¯à®•à®¿ à®ªà®¾à®°à¯à®µà¯ˆà®¯à®¾à®³à®°à¯à®•à®³à¯ˆ à®ˆà®°à¯à®•à¯à®•à¯à®¤à®²à¯.`,
      },
      source: 'https://contentmarketinginstitute.com/what-is-content-marketing/',
      quiz: {
        question: 'Content marketing primarily aims to:',
        options: [
          'Sell products directly',
          'Build brand awareness',
          'Spam users',
          'Decrease website traffic'
        ],
        answerIndex: 1
      }
    }
  ];

  // Set current language (for demo, English)
  let lang = 'en';

  // Build navigation buttons dynamically
  function buildNavigation() {
    modules.forEach((mod, i) => {
      const btn = document.createElement('button');
      btn.textContent = mod.title;
      btn.setAttribute('aria-controls', `module-${mod.id}`);
      btn.dataset.moduleId = mod.id;
      if (i === 0) btn.classList.add('active');
      btn.addEventListener('click', () => {
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        showModule(mod.id);
      });
      nav.appendChild(btn);
    });
  }

  // Show module by id, hide others
  function showModule(id) {
    document.querySelectorAll('.module-card').forEach(card => {
      card.style.display = card.id === `module-${id}` ? 'block' : 'none';
    });
  }

  // Create module cards with expandable content and quizzes
  function buildModules() {
    modules.forEach(mod => {
      const card = document.createElement('section');
      card.className = 'module-card';
      card.id = `module-${mod.id}`;
      card.setAttribute('tabindex', '0');
      if (mod !== modules[0]) card.style.display = 'none';

      // Header with title and toggle icon
      const header = document.createElement('div');
      header.className = 'module-header';
      header.innerHTML = `
        <h2>${mod.title}</h2>
        <span class="expand-icon" role="button" aria-expanded="false" tabindex="0" aria-label="Expand module details">+</span>
      `;
      card.appendChild(header);

      // Content container (collapsed by default)
      const content = document.createElement('div');
      content.className = 'module-content';
      content.innerHTML = `
        <p>${mod.description[lang]}</p>
        <p><a href="${mod.source}" class="source-link" target="_blank" rel="noopener noreferrer">Source</a></p>

        <div class="quiz-section" aria-label="Quiz section">
          <p><strong>Quiz:</strong> ${mod.quiz.question}</p>
          <ul class="quiz-options" role="radiogroup" aria-labelledby="quiz-question-${mod.id}">
            ${mod.quiz.options.map((opt, i) => `<li><label><input type="radio" name="quiz-${mod.id}" value="${i}" /> ${opt}</label></li>`).join('')}
          </ul>
          <button class="submit-btn" disabled>Submit Answer</button>
          <p class="quiz-result" aria-live="polite"></p>
        </div>
      `;
      card.appendChild(content);

      // Append to main container
      main.appendChild(card);

      // Event listeners for expand toggle
      const expandIcon = header.querySelector('.expand-icon');
      expandIcon.addEventListener('click', () => toggleExpand(content, expandIcon));
      expandIcon.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleExpand(content, expandIcon);
        }
      });

      // Quiz interaction logic
      const quizOptions = content.querySelectorAll('input[type=radio]');
      const submitBtn = content.querySelector('.submit-btn');
      const resultEl = content.querySelector('.quiz-result');

      quizOptions.forEach(opt => {
        opt.addEventListener('change', () => {
          submitBtn.disabled = false;
          resultEl.textContent = '';
          resultEl.className = 'quiz-result';
        });
      });

      submitBtn.addEventListener('click', () => {
        const selected = [...quizOptions].find(r => r.checked);
        if (!selected) return;
        const selectedVal = Number(selected.value);
        if (selectedVal === mod.quiz.answerIndex) {
          resultEl.textContent = 'Correct! ðŸŽ‰';
          resultEl.className = 'quiz-result correct';
        } else {
          resultEl.textContent = `Incorrect. Try again! âŒ`;
          resultEl.className = 'quiz-result incorrect';
        }
        submitBtn.disabled = true;
      });
    });
  }

  // Expand/collapse module content with animation
  function toggleExpand(content, icon) {
    const expanded = content.classList.toggle('expanded');
    icon.classList.toggle('expanded', expanded);
    icon.setAttribute('aria-expanded', expanded ? 'true' : 'false');
  }

  // Dark Mode Toggle
  function initDarkMode() {
    // Load saved preference
    const saved = localStorage.getItem('dm-darkmode');
    if (saved === 'true') document.body.classList.add('dark');
    updateDarkModeButton();

    darkToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      localStorage.setItem('dm-darkmode', document.body.classList.contains('dark'));
      updateDarkModeButton();
    });
  }
  function updateDarkModeButton() {
    darkToggle.textContent = document.body.classList.contains('dark') ? 'Light Mode' : 'Dark Mode';
  }

  // Simple chatbot logic with keyword responses
  function chatbotReply(message) {
    const msg = message.toLowerCase();

    const responses = [
      { keywords: ['seo'], reply: 'SEO helps improve your site ranking. Need tips on keyword research or backlinks?' },
      { keywords: ['social media', 'facebook', 'instagram', 'twitter'], reply: 'Social media marketing is great for audience engagement. Ask me about platforms!' },
      { keywords: ['google ads', 'ads', 'cpc'], reply: 'Google Ads allows you to run paid campaigns. I can explain CPC or ad formats.' },
      { keywords: ['email'], reply: 'Email marketing is powerful for nurturing leads. Want to know about personalization or tools?' },
      { keywords: ['affiliate'], reply: 'Affiliate marketing earns commissions by promoting products. Interested in affiliate networks?' },
      { keywords: ['analytics', 'data'], reply: 'Web analytics helps track your visitors and conversions. Ask me about Google Analytics metrics.' },
      { keywords: ['content'], reply: 'Content marketing attracts audiences with valuable content. Need ideas for blog or video content?' },
      { keywords: ['quiz'], reply: 'Try the quizzes in each module to test your knowledge! I can help explain answers too.' },
      { keywords: ['hello', 'hi', 'hey'], reply: 'Hello! How can I assist your digital marketing learning today?' },
      { keywords: ['help', 'support'], reply: 'I\'m here to help! Ask me any digital marketing related questions.' },
    ];

    for (const resp of responses) {
      if (resp.keywords.some(k => msg.includes(k))) {
        return resp.reply;
      }
    }
    // Default fallback
    return "Sorry, I didn't get that. Try asking about SEO, Social Media, Google Ads, or type 'help'.";
  }

  // Chatbot message render
  function addChatMessage(text, sender = 'bot') {
    const div = document.createElement('div');
    div.className = `chat-message ${sender}`;
    div.textContent = text;
    chatbotMessages.appendChild(div);
    chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
  }

  // Enable/disable send button depending on input
  chatbotInput.addEventListener('input', () => {
    chatbotSendBtn.disabled = chatbotInput.value.trim() === '';
  });

  // Chatbot form submit handler
  chatbotForm.addEventListener('submit', e => {
    e.preventDefault();
    const userMsg = chatbotInput.value.trim();
    if (!userMsg) return;
    addChatMessage(userMsg, 'user');
    chatbotInput.value = '';
    chatbotSendBtn.disabled = true;

    // Simulate bot thinking delay
    setTimeout(() => {
      const botReply = chatbotReply(userMsg);
      addChatMessage(botReply, 'bot');
    }, 600);
  });

  // Initialize everything
  function init() {
    buildNavigation();
    buildModules();
    initDarkMode();
  }

  // Run init on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();