(() => {
  // Get references to DOM elements
  const nav = document.querySelector('nav');
  const main = document.querySelector('main');
  const darkToggle = document.getElementById('darkModeToggle');
  const chatbotForm = document.getElementById('chatbot-form');
  const chatbotInput = document.getElementById('chatbot-input');
  const chatbotSendBtn = document.getElementById('chatbot-send-btn');
  const chatbotMessages = document.getElementById('chatbot-messages');

  // Module data copied from earlier HTML inline data
  const modules = [
    {
      id: 'seo',
      title: 'Search Engine Optimization (SEO)',
      description: {
        en: `SEO is the practice of optimizing your website to rank higher in search engine results, increasing organic traffic.`,
        ta: `SEO ‡Æé‡Æ©‡Øç‡Æ™‡Æ§‡ØÅ ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡Æ≤‡Øà‡Æ§‡Øç‡Æ§‡Æ≥‡Æ§‡Øç‡Æ§‡Øà ‡Æ§‡Øá‡Æü‡ØÅ‡Æ™‡Øä‡Æ±‡Æø ‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡ØÅ‡Æï‡Æ≥‡Æø‡Æ≤‡Øç ‡ÆÆ‡Øá‡Æ≤‡Øç‡Æ®‡Æø‡Æ≤‡Øà ‡Æ™‡ØÜ‡Æ±‡Æö‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡ØÅ‡Æ±‡Øà‡ÆØ‡Ææ‡Æï‡ØÅ‡ÆÆ‡Øç, ‡Æá‡Æ§‡ØÅ ‡Æá‡ÆØ‡Æ≤‡Øç‡Æ™‡ØÅ‡Æ®‡Æø‡Æ≤‡Øà‡Æ™‡Øç ‡Æ™‡Øã‡Æï‡Øç‡Æï‡ØÅ‡Æµ‡Æ∞‡Æ§‡Øç‡Æ§‡Øà ‡ÆÖ‡Æ§‡Æø‡Æï‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.`,
      },
      source: 'https://moz.com/beginners-guide-to-seo',
      quiz: {
        question: 'Which of these is NOT a common SEO practice?',
        options: [
          'Keyword research',
          'Backlink building',
          'Buying fake followers',
          'On-page optimization'
        ],
        answerIndex: 2
      }
    },
    {
      id: 'social-media',
      title: 'Social Media Marketing',
      description: {
        en: `Marketing using platforms like Facebook, Instagram, Twitter to engage and grow your audience.`,
        ta: `Facebook, Instagram, Twitter ‡Æ™‡Øã‡Æ©‡Øç‡Æ± ‡Æ§‡Æ≥‡Æô‡Øç‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æø ‡ÆÆ‡Æï‡Øç‡Æï‡Æ≥‡Øç ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡Øà ‡Æµ‡Æ≥‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡Æ§‡ØÅ.`,
      },
      source: 'https://sproutsocial.com/insights/social-media-marketing-strategy/',
      quiz: {
        question: 'Which platform is best known for professional networking?',
        options: [
          'Facebook',
          'Instagram',
          'LinkedIn',
          'Snapchat'
        ],
        answerIndex: 2
      }
    },
    {
      id: 'google-ads',
      title: 'Google Ads',
      description: {
        en: `Paid advertising on Google to reach customers instantly with targeted ads.`,
        ta: `‡Æï‡ØÇ‡Æï‡ØÅ‡Æ≥‡Æø‡Æ≤‡Øç ‡Æ™‡Æ£‡ÆÆ‡Øç ‡Æö‡ØÜ‡Æ≤‡ØÅ‡Æ§‡Øç‡Æ§‡Æø ‡Æµ‡Æø‡Æ≥‡ÆÆ‡Øç‡Æ™‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øà ‡Æ®‡Æü‡Ææ‡Æ§‡Øç‡Æ§‡Æø ‡Æï‡ØÅ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øã‡Æ≥‡Øç ‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç‡Æï‡Æ≥‡Øà ‡ÆÖ‡Æü‡Øà‡ÆØ‡Æ≤‡Ææ‡ÆÆ‡Øç.`,
      },
      source: 'https://ads.google.com/home/',
      quiz: {
        question: 'What does CPC stand for in Google Ads?',
        options: [
          'Cost Per Click',
          'Cost Per Customer',
          'Click Per Cost',
          'Customer Paid Cost'
        ],
        answerIndex: 0
      }
    },
    {
      id: 'email-marketing',
      title: 'Email Marketing',
      description: {
        en: `Sending targeted emails to nurture leads and convert customers.`,
        ta: `‡Æá‡Æ£‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Øç ‡Æï‡Æü‡Æø‡Æ§‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÖ‡Æ©‡ØÅ‡Æ™‡Øç‡Æ™‡Æø ‡Æµ‡Ææ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç‡Æï‡Æ≥‡Øà ‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ØÅ‡Æ§‡Æ≤‡Øç.`,
      },
      source: 'https://mailchimp.com/email-marketing/',
      quiz: {
        question: 'Which is a good practice in email marketing?',
        options: [
          'Sending spam emails',
          'Personalizing emails',
          'Ignoring unsubscribe requests',
          'Buying email lists'
        ],
        answerIndex: 1
      }
    },
    {
      id: 'affiliate-marketing',
      title: 'Affiliate Marketing',
      description: {
        en: `Promoting other companies‚Äô products to earn commissions.`,
        ta: `‡Æ™‡Æø‡Æ± ‡Æ®‡Æø‡Æ±‡ØÅ‡Æµ‡Æ©‡Æô‡Øç‡Æï‡Æ≥‡Æø‡Æ©‡Øç ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øà ‡Æµ‡Æø‡Æ≥‡ÆÆ‡Øç‡Æ™‡Æ∞‡ÆÆ‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡ØÅ ‡Æï‡ÆÆ‡Æø‡Æ∑‡Æ©‡Øç ‡Æ™‡ØÜ‡Æ±‡ØÅ‡Æ§‡Æ≤‡Øç.`,
      },
      source: 'https://www.bigcommerce.com/articles/affiliate-marketing/',
      quiz: {
        question: 'Affiliate marketers earn money based on:',
        options: [
          'Product views',
          'Clicks on ads',
          'Sales or leads generated',
          'Social media followers'
        ],
        answerIndex: 2
      }
    },
    {
      id: 'analytics',
      title: 'Web Analytics',
      description: {
        en: `Tracking and analyzing website data to improve marketing efforts.`,
        ta: `‡Æá‡Æ£‡Øà‡ÆØ‡Æ§‡Øç‡Æ§‡Æ≥ ‡Æ§‡Æ∞‡Æµ‡Øà ‡Æï‡Æ£‡Øç‡Æï‡Ææ‡Æ£‡Æø‡Æ§‡Øç‡Æ§‡ØÅ ‡Æö‡Æ®‡Øç‡Æ§‡Øà‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æ≤‡Øç ‡ÆÆ‡Øá‡ÆÆ‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æ≤‡Øç.`,
      },
      source: 'https://analytics.google.com/',
      quiz: {
        question: 'Which metric measures website visitor count?',
        options: [
          'Bounce Rate',
          'Sessions',
          'CTR',
          'Impressions'
        ],
        answerIndex: 1
      }
    },
    {
      id: 'content-marketing',
      title: 'Content Marketing',
      description: {
        en: `Creating valuable content to attract and engage your audience.`,
        ta: `‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡ÆÆ‡Æø‡Æï‡Øç‡Æï ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æü‡Æï‡Øç‡Æï‡ÆÆ‡Øç ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡Æø ‡Æ™‡Ææ‡Æ∞‡Øç‡Æµ‡Øà‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç‡Æï‡Æ≥‡Øà ‡Æà‡Æ∞‡Øç‡Æï‡Øç‡Æï‡ØÅ‡Æ§‡Æ≤‡Øç.`,
      },
      source: 'https://contentmarketinginstitute.com/what-is-content-marketing/',
      quiz: {
        question: 'Content marketing primarily aims to:',
        options: [
          'Sell products directly',
          'Build brand awareness',
          'Spam users',
          'Decrease website traffic'
        ],
        answerIndex: 1
      }
    }
  ];

  // Set current language (for demo, English)
  let lang = 'en';

  // Build navigation buttons dynamically
  function buildNavigation() {
    modules.forEach((mod, i) => {
      const btn = document.createElement('button');
      btn.textContent = mod.title;
      btn.setAttribute('aria-controls', `module-${mod.id}`);
      btn.dataset.moduleId = mod.id;
      if (i === 0) btn.classList.add('active');
      btn.addEventListener('click', () => {
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        showModule(mod.id);
      });
      nav.appendChild(btn);
    });
  }

  // Show module by id, hide others
  function showModule(id) {
    document.querySelectorAll('.module-card').forEach(card => {
      card.style.display = card.id === `module-${id}` ? 'block' : 'none';
    });
  }

  // Create module cards with expandable content and quizzes
  function buildModules() {
    modules.forEach(mod => {
      const card = document.createElement('section');
      card.className = 'module-card';
      card.id = `module-${mod.id}`;
      card.setAttribute('tabindex', '0');
      if (mod !== modules[0]) card.style.display = 'none';

      // Header with title and toggle icon
      const header = document.createElement('div');
      header.className = 'module-header';
      header.innerHTML = `
        <h2>${mod.title}</h2>
        <span class="expand-icon" role="button" aria-expanded="false" tabindex="0" aria-label="Expand module details">+</span>
      `;
      card.appendChild(header);

      // Content container (collapsed by default)
      const content = document.createElement('div');
      content.className = 'module-content';
      content.innerHTML = `
        <p>${mod.description[lang]}</p>
        <p><a href="${mod.source}" class="source-link" target="_blank" rel="noopener noreferrer">Source</a></p>

        <div class="quiz-section" aria-label="Quiz section">
          <p><strong>Quiz:</strong> ${mod.quiz.question}</p>
          <ul class="quiz-options" role="radiogroup" aria-labelledby="quiz-question-${mod.id}">
            ${mod.quiz.options.map((opt, i) => `<li><label><input type="radio" name="quiz-${mod.id}" value="${i}" /> ${opt}</label></li>`).join('')}
          </ul>
          <button class="submit-btn" disabled>Submit Answer</button>
          <p class="quiz-result" aria-live="polite"></p>
        </div>
      `;
      card.appendChild(content);

      // Append to main container
      main.appendChild(card);

      // Event listeners for expand toggle
      const expandIcon = header.querySelector('.expand-icon');
      expandIcon.addEventListener('click', () => toggleExpand(content, expandIcon));
      expandIcon.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleExpand(content, expandIcon);
        }
      });

      // Quiz interaction logic
      const quizOptions = content.querySelectorAll('input[type=radio]');
      const submitBtn = content.querySelector('.submit-btn');
      const resultEl = content.querySelector('.quiz-result');

      quizOptions.forEach(opt => {
        opt.addEventListener('change', () => {
          submitBtn.disabled = false;
          resultEl.textContent = '';
          resultEl.className = 'quiz-result';
        });
      });

      submitBtn.addEventListener('click', () => {
        const selected = [...quizOptions].find(r => r.checked);
        if (!selected) return;
        const selectedVal = Number(selected.value);
        if (selectedVal === mod.quiz.answerIndex) {
          resultEl.textContent = 'Correct! üéâ';
          resultEl.className = 'quiz-result correct';
        } else {
          resultEl.textContent = `Incorrect. Try again! ‚ùå`;
          resultEl.className = 'quiz-result incorrect';
        }
        submitBtn.disabled = true;
      });
    });
  }

  // Expand/collapse module content with animation
  function toggleExpand(content, icon) {
    const expanded = content.classList.toggle('expanded');
    icon.classList.toggle('expanded', expanded);
    icon.setAttribute('aria-expanded', expanded ? 'true' : 'false');
  }

  // Dark Mode Toggle
  function initDarkMode() {
    // Load saved preference
    const saved = localStorage.getItem('dm-darkmode');
    if (saved === 'true') document.body.classList.add('dark');
    updateDarkModeButton();

    darkToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      localStorage.setItem('dm-darkmode', document.body.classList.contains('dark'));
      updateDarkModeButton();
    });
  }
  function updateDarkModeButton() {
    darkToggle.textContent = document.body.classList.contains('dark') ? 'Light Mode' : 'Dark Mode';
  }

  // Simple chatbot logic with keyword responses
  function chatbotReply(message) {
    const msg = message.toLowerCase();

    const responses = [
      { keywords: ['seo'], reply: 'SEO helps improve your site ranking. Need tips on keyword research or backlinks?' },
      { keywords: ['social media', 'facebook', 'instagram', 'twitter'], reply: 'Social media marketing is great for audience engagement. Ask me about platforms!' },
      { keywords: ['google ads', 'ads', 'cpc'], reply: 'Google Ads allows you to run paid campaigns. I can explain CPC or ad formats.' },
      { keywords: ['email'], reply: 'Email marketing is powerful for nurturing leads. Want to know about personalization or tools?' },
      { keywords: ['affiliate'], reply: 'Affiliate marketing earns commissions by promoting products. Interested in affiliate networks?' },
      { keywords: ['analytics', 'data'], reply: 'Web analytics helps track your visitors and conversions. Ask me about Google Analytics metrics.' },
      { keywords: ['content'], reply: 'Content marketing attracts audiences with valuable content. Need ideas for blog or video content?' },
      { keywords: ['quiz'], reply: 'Try the quizzes in each module to test your knowledge! I can help explain answers too.' },
      { keywords: ['hello', 'hi', 'hey'], reply: 'Hello! How can I assist your digital marketing learning today?' },
      { keywords: ['help', 'support'], reply: 'I\'m here to help! Ask me any digital marketing related questions.' },
    ];

    for (const resp of responses) {
      if (resp.keywords.some(k => msg.includes(k))) {
        return resp.reply;
      }
    }
    // Default fallback
    return "Sorry, I didn't get that. Try asking about SEO, Social Media, Google Ads, or type 'help'.";
  }

  // Chatbot message render
  function addChatMessage(text, sender = 'bot') {
    const div = document.createElement('div');
    div.className = `chat-message ${sender}`;
    div.textContent = text;
    chatbotMessages.appendChild(div);
    chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
  }

  // Enable/disable send button depending on input
  chatbotInput.addEventListener('input', () => {
    chatbotSendBtn.disabled = chatbotInput.value.trim() === '';
  });

  // Chatbot form submit handler
  chatbotForm.addEventListener('submit', e => {
    e.preventDefault();
    const userMsg = chatbotInput.value.trim();
    if (!userMsg) return;
    addChatMessage(userMsg, 'user');
    chatbotInput.value = '';
    chatbotSendBtn.disabled = true;

    // Simulate bot thinking delay
    setTimeout(() => {
      const botReply = chatbotReply(userMsg);
      addChatMessage(botReply, 'bot');
    }, 600);
  });

  // Initialize everything
  function init() {
    buildNavigation();
    buildModules();
    initDarkMode();
  }

  // Run init on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();